<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宝物を探せ！</title>
    <style>
        body,button {
            font-size: 120%;
            text-align: center;
            margin-top: 50px;
        }
    body {
      background-color: yellow; /* 背景色を黄色に設定 */
      margin: 10px; /* 余白をなくす */
    }

        #status {
            font-weight: bold;
        }

        #coordinates {
            margin-top: 20px;
        }
	h1{
	    text-align:center;
	    margin:0;padding:0;
	}
    </style>

<!-- ◆セリフのプリロード -->
    <link rel="preload" href="/panpan/0000.mp3" as="audio">
    <link rel="preload" href="/panpan/0001.mp3" as="audio">
    <link rel="preload" href="/panpan/0002.mp3" as="audio">
    <link rel="preload" href="/panpan/0003.mp3" as="audio">
    <audio id="audioPlayer" preload="auto"></audio>

    <link rel="preload" href="/panpan/bgm0000.mp3" as="audio">
    <audio id="bgm0000" loop>
        <source src="/panpan/bgm0000.mp3" type="audio/mp3">
    </audio>


</head>
<body>
<h1>宝物をさがせ！</h1>

<button id="startTour" onclick="startTour()">ツアーを開始する</button>
<button id="stopTour" onclick="stopTour()" style="display:none;">ツアーを終了</button>
<p><button id="stopbgmBTN" onclick="stopBGM()" style="display:none;">BGMを止める</button></p>
<p id="mess">ツアーを開始しよう。</p>
<p id="status">※サンプルツアーです。</p>
<p id="imageContainer"><img id="myImage" src="/panpan/tour.jpg" alt="ツアー" width="280" /></p>
<p id="coordinates">目標との差分:</p>

<script>
let watchId;
let alerted = false;

// 各地点で表示する画像
const imagePaths = [
    '/panpan/0000.jpg',
    '/panpan/0001.jpg',
    '/panpan/0002.jpg',
    '/panpan/0003.jpg'
];

const imageElement = document.getElementById('myImage');

// 画像をプリロード
function preloadImages() {
    for (let i = 0; i < imagePaths.length; i++) {
      const img = new Image();
      img.src = imagePaths[i];
    }
}

const targetSpots = [
    { latitude: 35.8386737, longitude: 139.5858670 },
    { latitude: 35.8387419, longitude: 139.5860916 },
    { latitude: 35.8386737, longitude: 139.5858670 }
];

// 各地点に対応するメッセージの配列
const spotMessages = [
    '目標：スタート地点をめざそう！',
    '目標：宝箱をさがそう',
    '目標：ゴールをめざそう',
    'ツアーお疲れ様！アンケートに答えてね！'
];

let currentSpotIndex = 0;
const targetRadius = 5;

// MP3再生関数
function playAudio(audioFile) {
    const audioPlayer = document.getElementById('audioPlayer');
    audioPlayer.src = audioFile;
    audioPlayer.play();
}

// BGM再生
    const bgm = document.getElementById('bgm');

function startBGM() {
    bgm0000.play();
}

function stopBGM() {
    bgm0000.pause();
    bgm0000.currentTime = 0;  // 停止したら再生位置をリセット
}


// ツアー開始
function startTour() {
    const startButton = document.getElementById('startTour');
    const stopButton = document.getElementById('stopTour');
    const statusText = document.getElementById('status');
    const messText = document.getElementById('mess');
    const stopbgmBTN = document.getElementById('stopbgmBTN');
    const coordinatesText = document.getElementById('coordinates');

//オープニングメッセージ

    alert('歩きスマホはしないで下さい');

    startBGM();
    playAudio(`0000.mp3`);

    startButton.style.display = 'none';
    stopButton.style.display = 'inline';
    stopbgmBTN.style.display = 'none';

    const messageIndex = currentSpotIndex;
    const message = spotMessages[messageIndex];
    messText.innerText = message;

    statusText.innerText = '※ツアー中は歩きスマホはやめてね';
    imageElement.src = imagePaths[currentSpotIndex];


// メインルーチン（ループ）
    watchId = navigator.geolocation.watchPosition(
        (position) => {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            const currentSpot = targetSpots[currentSpotIndex];
            const distance = calculateDistance(latitude, longitude, currentSpot.latitude, currentSpot.longitude);

            const targetCoordinates = `目標緯度: ${currentSpot.latitude.toFixed(6)},目標経度: ${currentSpot.longitude.toFixed(6)}\n`;

            const currentCoordinates = `緯度: ${latitude.toFixed(6)},経度: ${longitude.toFixed(6)},\n 差分: ${distance.toFixed(2)} メートル\n`;

            coordinatesText.innerText = `${currentCoordinates}\n${targetCoordinates}`;

// エリア侵入
            if (distance <= targetRadius && !alerted) {
                const messageIndex = currentSpotIndex;
                const message = spotMessages[messageIndex +1 ];
                messText.innerText = message;

                playAudio(`000${messageIndex + 1}.mp3`);
                imageElement.src = imagePaths[currentSpotIndex +1 ];

                alerted = true;

                // 次の目標の緯度経度を表示
                const nextSpot = targetSpots[currentSpotIndex + 1];
                const nextTargetCoordinates = `次の目標緯度: ${nextSpot.latitude.toFixed(6)}, 次の目標経度: ${nextSpot.longitude.toFixed(6)}`;
                coordinatesText.innerText += `${nextTargetCoordinates}`;

            }

// 終了判定
            if (distance <= targetRadius) {
                currentSpotIndex++;
                alerted = false;
                if (currentSpotIndex >= targetSpots.length) {
                    stopTour();
                }
            }
        },
        (error) => {
            console.error('位置情報の取得に失敗しました。', error);
        },
        { enableHighAccuracy: true }
    );
}

// ツアー終了
function stopTour() {
    const startButton = document.getElementById('startTour');
    const stopButton = document.getElementById('stopTour');
    const stopbgmBTN = document.getElementById('stopbgmBTN');
    const messText = document.getElementById('mess');
    const statusText = document.getElementById('status');
    const coordinatesText = document.getElementById('coordinates');

    startButton.style.display = 'none';
    stopButton.style.display = 'none';
    stopbgmBTN.style.display = 'inline';

    statusText.innerText = 'statusツアー制作：カグア！';
    coordinatesText.innerText = 'ツアーを終了です！お疲れ様でした。';

    navigator.geolocation.clearWatch(watchId);
    alerted = false;
    currentSpotIndex = 0;
}


// 緯度経度計算
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = degToRad(lat2 - lat1);
    const dLon = degToRad(lon2 - lon1);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(degToRad(lat1)) * Math.cos(degToRad(lat2)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const distance = R * c;

    return distance;
}

function degToRad(deg) {
    return deg * (Math.PI / 180);
}


</script>
<p><a rel="nofollow" href="/panpan/index.html"><strong>トップ</strong></a>　|　<a rel="nofollow" href="/panpan/map.html"><strong>判定</strong></a>　|　<a rel="nofollow" href="/panpan/record.html"><strong>記録</strong></a>　|　<a rel="nofollow" href="/panpan/geo.html"><strong>試験</strong></a>　|　<a rel="nofollow" href="/panpan/kappa.html"><strong>かっぱ</strong></a></p>

</body>
</html>
