<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>スタンプラリー</title>
<style>
    /* リストのスタイル */
    @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap');
    body {
        font-family: 'Open Sans', sans-serif;
    }
    #spotsList {
        padding: 20px;
    }
    #spotsList li {
        list-style-type: decimal;
        color: black;
    }
</style>
</head>
<body>
    <h2>スタンプラリー</h2>
    <!-- ツアー開始/中断ボタン -->
    <button id="tourButton" onclick="toggleTour()">声ツアーを開始する</button>
    <!-- スポットリスト -->
    <ol id="spotsList"></ol>
    <!-- 現在位置情報表示 -->
    <p id="currentLocation"></p>
    <!-- 完了メッセージ -->
    <p id="completionMessage" style="display: none;">全てのスポットを回りました！</p>
    <!-- 完了ボタン -->
    <button id="completeButton" style="display: none;" onclick="showGoal()">完了メッセージを聴く</button>
    <!-- ゴール画像 -->
    <img id="goalImage" style="display: none;" src="goal.jpg" alt="ゴール画像">

    <script>
        // スポット情報
        var spots = [
            { coords: { latitude: 35.83849919524573, longitude: 139.58592441971976 }, name: "やまや", audioPlayed: false },
            { coords: { latitude: 35.83865155821823, longitude: 139.58584334419047 }, name: "電柱", audioPlayed: false }
        ];

        // オーディオ要素の初期化
        var audio = new Audio();
        var bgm = new Audio("bgm.mp3");
        var goalAudio = new Audio("goal.mp3");

        // メッセージと画像の初期化
        var completeMessage = "声ツアーが完了しました。";
        var goalImageSrc = "goal.jpg";

        // ツアーの状態を管理する変数
        var tourStarted = false;
        var watchID = null;
        var lastPlayedSpotIndex = null;
        var completedSpots = [];

        // スポット番号.mp3 をプリロード
        spots.forEach(function(spot, index) {
            var spotAudio = new Audio(index + ".mp3");
            spotAudio.load();
        });

        // ツアーの開始/中断を切り替える関数
        function toggleTour() {
            if (!tourStarted) {
                startTour();
                tourStarted = true;
                document.getElementById("tourButton").innerText = "中断する";
            } else {
                stopTour();
                tourStarted = false;
                document.getElementById("tourButton").innerText = "声ツアーを開始する";
            }
        }

        // ツアーを開始する関数
        function startTour() {
            bgm.play();
            displaySpots(); // スポットリストを表示
            watchID = navigator.geolocation.watchPosition(updateCurrentLocation, handleError, { enableHighAccuracy: true });
        }

        // ツアーを中断する関数
        function stopTour() {
            bgm.pause();
            navigator.geolocation.clearWatch(watchID);
            audio.pause();
        }

        // スポット情報をリスト表示
        function displaySpots() {
            var spotsList = document.getElementById("spotsList");
            spotsList.innerHTML = ""; // リストをクリア

            spots.forEach(function(spot, index) {
                var spotElement = document.createElement("li");
                spotElement.id = "spot_" + index;
                spotElement.innerText = spot.name;
                spotsList.appendChild(spotElement);
            });
        }

        // 現在位置情報を更新する関数
        function updateCurrentLocation(position) {
            var currentCoords = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude
            };

            // 現在位置情報を表示
            document.getElementById("currentLocation").innerText = "現在の緯度経度: " + currentCoords.latitude.toFixed(6) + ", " + currentCoords.longitude.toFixed(6);

            // 各スポットの距離を計算して表示
            spots.forEach(function(spot, index) {
                var distance = calculateDistance(currentCoords, spot.coords);
                var spotElement = document.getElementById("spot_" + index);
                var spotName = spot.name;

                // スポットに近づいたら再生
                if (distance <= 5 && !spot.audioPlayed) {
                    var spotAudio = new Audio(index + ".mp3");
                    spotAudio.play();
                    spot.audioPlayed = true;
                    spotName = "*" + spotName; // スポット名の前に * を追加
                    completedSpots.push(index); // スポットを完了として追加
                }

                // スポット名と残り距離を表示
                spotElement.innerText = spotName + " (残り: " + distance.toFixed(2) + "m)";
            });

            // すべてのスポットが再生されたらコンプリートメッセージを表示
            if (completedSpots.length === spots.length) {
                document.getElementById("completionMessage").style.display = "block";
                document.getElementById("completeButton").style.display = "block";
            }
        }

        // 2点間の距離を計算する関数
        function calculateDistance(coords1, coords2) {
            var R = 6371e3; // 地球の半径 (m)
            var lat1 = coords1.latitude * Math.PI / 180; // 緯度1 (ラジアン)
            var lat2 = coords2.latitude * Math.PI / 180; // 緯度2 (ラジアン)
            var dLat = (coords2.latitude - coords1.latitude) * Math.PI / 180; // 緯度の差 (ラジアン)
            var dLon = (coords2.longitude - coords1.longitude) * Math.PI / 180; // 経度の差 (ラジアン)

            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);

            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            var distance = R * c; // 2点間の距離 (m)
            return distance;
        }

        // エラーハンドリング
        function handleError(error) {
            console.log('位置情報の取得中にエラーが発生しました:', error.message);
        }

        // 完了メッセージを表示する関数
        function showGoal() {
            document.getElementById("goalImage").style.display = "block";
            goalAudio.play();
        }
    </script>
</body>
</html>
